<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" /> <!--[if lte IE 9]><meta http-equiv="refresh" content="0;url=/ie.html"><![endif]--> <title>how to run a script after network interface up</title> <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,400italic,600|Droid+Sans+Mono' rel='stylesheet' type='text/css'> <link rel="stylesheet" href="/css/main.css"> <link rel="canonical" href="http://www.echoed.me/2016/04/30/how-to-run-a-script-after-network-interface-up/"> <link rel="alternate" type="application/rss+xml" title="Echo's Blog" href="http://www.echoed.me/feed.xml" /> <script src="/assets/js/prefixfree.js"></script> </head> <body> <aside id="sidebar"> <div id="sidebar-left"> <a id="sidebar-avatar" href="/"> <img id="sidebar-avatar-img" alt="" src="/assets/img/avatar.jpg"/> </a> <div id="sidebar-social"> <a href="/feed.xml" class="sidebar-social-icon feed"></a> <a href="mailto:echohn@gmail.com" class="sidebar-social-icon email"></a> <a href="https://twitter.com/echo_hon" class="sidebar-social-icon twitter" target="_blank"></a> <a href="http://www.weibo.com/1130234205" class="sidebar-social-icon weibo" target="_blank"></a> <a href="https://github.com/echohn" class="sidebar-social-icon github" target="_blank"></a> </div> <ul id="sidebar-tags"> <li class="sidebar-tag active" data-filter="all">全部文章</li> <li class="sidebar-tag" data-filter="杂记">杂记</li> <li class="sidebar-tag" data-filter="Mac">Mac</li> <li class="sidebar-tag" data-filter="Alfred">Alfred</li> <li class="sidebar-tag" data-filter="Ruby">Ruby</li> <li class="sidebar-tag" data-filter="Safari">Safari</li> <li class="sidebar-tag" data-filter="运维">运维</li> <li class="sidebar-tag" data-filter="script">script</li> <li class="sidebar-tag" data-filter="linux">linux</li> </ul> </div> <div id="sidebar-right"> <div id="search-box"> <input id="search-input" type="text" placeholder="Search" /> </div> <nav id="toc"> <a class="toc-link" data-tags="script linux" href="/2016/04/30/how-to-run-a-script-after-network-interface-up/"> how to run a script after network interface up </a> <a class="toc-link" data-tags="运维" href="/2016/02/03/server-os-choose-rhel-cenos-or-debian-ubuntu/"> 服务器操作系统应该选择 RHEL/CentOS 还是 Debian/Ubuntu ？ </a> <a class="toc-link" data-tags="Mac Safari" href="/mac/2015/12/06/analyse_my_safari_history/"> 分析自己的 Safari 历史记录 </a> <a class="toc-link" data-tags="Mac Ruby Alfred" href="/2015/10/17/rubygems-workflow/"> 搜索 rubygems 并安装的 Alfred Workflow </a> <a class="toc-link" data-tags="Ruby" href="/2015/10/17/ruby-destructuring/"> Ruby 强制解构 </a> <a class="toc-link" data-tags="Alfred Ruby Mac" href="/2015/10/17/alfred_tips/"> Alfred 自动补全的技巧 </a> <a class="toc-link" data-tags="Mac Alfred" href="/2015/04/19/search_ip_location_alfred/"> 查询 IP 地址位置的 Alfred Workflow </a> <a class="toc-link" data-tags="杂记" href="/2015/02/16/hello-world/"> 严重的拖延症患者 </a> </nav> </div> </aside> <main id="main"> <article class="post container"> <div class="post-meta"> <span class="post-meta-span date">2016 April 30</span> <span class="post-meta-span tag">script, linux</span> </div> <h1 class="post-title">how to run a script after network interface up</h1> <p>我懒，我喜欢让自己的工作环境变得轻松，喜欢 Automate Everything 。</p> <p>今天在用 Vmware Fusion 测东西的时候，我就发现我虽然在虚机模板上做了各种优化，但是每次新创建一个链接克隆的时候，我居然还要在 Fusion 中进入虚机，登录，敲个<code>ip a</code>看一下 ip 地址，再 <code>⌃</code> + <code>⌘</code> 退出虚机，然后才能在 iTerm 中 ssh 这个虚机，这让大处女座怎么忍（其实我是射手）！</p> <p>所以就想，干脆启动虚机的时候能看到 ip 地址就好啦。</p> <p>虽然 /etc/issue 是纯文本，可是这怎么能难住哥，我很快就写好了一个在 /etc/issue 显示 ip 地址的小脚本。</p> <p>然后正当习惯性想把脚本加到 rc.local 的时候，突然想到，这样岂不是只能开机启动了才生效？IP 地址是与网卡绑定的，得随网卡启动才好吧。</p> <p>我之前虽然试过在网卡启动后自动添加路由，可是还没试过在网卡启动之后自动运行脚本呢。</p> <p>直接 google，找到了<a href="http://xmodulo.com/how-to-run-startup-script-automatically-after-network-interface-is-up-on-centos.html">这篇文章</a>。</p> <p>嗯，ifup-post 脚本里真有下面这么一句呢（其实没有自己手动添也行）。</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="k">if</span> <span class="o">[</span> -x /sbin/ifup-local <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    /sbin/ifup-local <span class="k">${</span><span class="nv">DEVICE</span><span class="k">}</span></code></pre></div> <p>于是就写了 <code>/sbin/ifup-local</code> 这么个脚本。</p> <p>因为这个脚本是每启动一个网卡就要执行一次，我嫌麻烦还要判断网卡，干脆就直接都写一样的了。</p> <div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>

<span class="nv">addr</span><span class="o">=</span><span class="k">$(</span>ip a <span class="p">|</span> awk <span class="s1">&#39;/scope global/{print $NF&quot; ipaddress : &quot;$2}&#39;</span><span class="k">)</span>
<span class="nv">file</span><span class="o">=</span><span class="s2">&quot;/etc/issue&quot;</span>

sed -i <span class="s1">&#39;/ipaddress/d&#39;</span> <span class="nv">$file</span>
sed -i <span class="s1">&#39;/^$/d&#39;</span> <span class="nv">$file</span>

mv <span class="nv">$file</span> <span class="k">${</span><span class="nv">file</span><span class="k">}</span>.bak
<span class="nb">echo</span> <span class="nv">$addr</span> &gt; <span class="nv">$file</span>
<span class="nb">echo</span> &gt;&gt; <span class="nv">$file</span>
cat <span class="k">${</span><span class="nv">file</span><span class="k">}</span>.bak &gt;&gt; <span class="nv">$file</span></code></pre></div> <p>最后新建一台虚机看一下效果，完美~！</p> <p><img src="/assets/post_images/3.png" alt="" /></p> </article> <div class="post-share"> <div class="container"> <a href="https://twitter.com/share?url=http://www.echoed.me/2016/04/30/how-to-run-a-script-after-network-interface-up/&text=how to run a script after network interface up" target="_blank" class="post-share-icon twitter"></a> <a href="https://www.evernote.com/clip.action?url=http://www.echoed.me/2016/04/30/how-to-run-a-script-after-network-interface-up/&title=how to run a script after network interface up" target="_blank" class="post-share-icon evernote"></a> <a href="http://service.weibo.com/share/share.php?url=http://www.echoed.me/2016/04/30/how-to-run-a-script-after-network-interface-up/&title=how to run a script after network interface up" target="_blank" class="post-share-icon weibo"></a> </div> </div> <div class="comment container"> <div id="disqus_thread"> <a href=""></a> </div> </div> <div class="footer"> <div class="container"> <p class="footer-entry">All content is licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA</a></p> <p class="footer-entry">Buit with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> and <a href="https://github.com/P233/3-Jekyll" target="_blank">3-Jekyll theme</a> • Hosted on <a href="https://pages.github.com/" target="_blank">Github</a></p> </div> </div> </main> <button id="menu"> <span id="menu-icons"></span> </button> <script src="/assets/js/jquery-2.1.3.min.js"></script> <script src="/assets/js/jquery.pjax.js"></script> <script src="/assets/js/nprogress.js"></script> <script src="/assets/js/main.js"></script> </body> </html>
